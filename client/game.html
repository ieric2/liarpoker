<html>

<head>
  <script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>

  <script>
  </script>
</head>


<body>
  <div id="gameScreen">
    <!-- Add a player turn display -->
    <!-- Add a turn history tracker -->
    <text id="playerTurn">

    </text>
    <div class="container" style="display: flex;">
      <canvas id="ctx"  style="width:33%;height:500px; border:2px solid #000000;"></canvas> 
      <div style="width:33%; padding-left: 10px;">
        <div id="chat" style="height:500px; overflow-y:scroll;">
        </div>
        </br>
        <text>
          Chat Here:
        </text>
        <form id="chatForm">
          <input id="chatInput" type="text" style="height:30px;width:95%">
        </form>
      </div>
      <div id="moveHistory" style="width:33%;height:500px; overflow-y:scroll; padding-left: 10px;">
      </div>
    </div>
    <br>
    <div class="container" style="display: flex;">
      <div style="width:33%; vertical-align: top;">
        <form action="result.php" method="post" id="handSelection" style="display: none">
          <select name="category" id="handTypeSelector" style="vertical-align: top;">
            <option value="highCard">High Card</option>
            <option value="pair">Pair</option>
            <option value="twoPair">Two Pair</option> 
            <option value="triple">Three of a Kind</option> 
            <option value="straight">Straight</option> 
            <option value="flush">Flush</option>
            <option value="fullHouse">Full House</option> 
            <option value="quad">Four of a Kind</option>
            <option value="straightFlush">Straight Flush</option> 
            <option value="royalFlush">Royal Flush</option>
          </select>
          <select name="choices[]" id="handSubtypeSelector" size="4" style="min-width: 100px;">
              <!-- js populates -->
          </select>
          <select name="choices2[]" id="handSubtype2Selector" size="4" style="min-width: 100px;">
            <!-- js populates -->
          </select>
          <p></p>
          <button type="button" onclick="playTurn()">Submit Hand</button>
          <button type="button" onclick="castDoubt()">Cast Doubt</button>
        </form>
        <br><br>
        <!-- <form> -->
          <!-- <input type="checkbox" value = "/> -->
          <input type="button" name="startGameButton" value= "Start Game" onclick="startGame()"/>
        <!-- </form> -->
      </div>
      <text>
        Player List:
      </text>
      <div id="playerList" style="width:33%;height:500px; overflow-y:scroll; padding-left: 10px;">
      </div>
    </div>
  </div>


  <script>
    var cards = {}

    const socket = io();
    const id = socket.id;
    var session_id;
    let data = sessionStorage.getItem('sessionId');
    if (data == null) {
        session_id = null
    } else {
        session_id = data//when we connect n times 
    }
    socket.emit('startSession', {  sessionId: session_id })

    const chatForm = document.getElementById("chatForm");
    const chatInput = document.getElementById("chatInput");
    const playerTurn = document.getElementById("playerTurn");
    const moveHistory = document.getElementById("moveHistory");
    const playerListTag = document.getElementById("playerList");
    const canvas = document.getElementById("ctx")
    const ctx = canvas.getContext("2d");
    ctx.font = '30px Arial';


    // function joinGame(){
    //   socket.emit("joinGame");
    // }

    function startGame(){
      console.log("starting game");
      socket.emit('test1');
      socket.emit('test2');
      socket.emit('startGame');
    }

    function playTurn(){
      var handType = document.getElementById("handTypeSelector").value;
      var handVariant = document.getElementById("handSubtypeSelector").value;
      var handVariant2 = document.getElementById("handSubtype2Selector").value;
      console.log("turn")
      socket.emit("playTurn", {0: handType, 1: handVariant, 2: handVariant2});
    }

    function castDoubt(){
      socket.emit("checkHand");
    }

    socket.on('sessionAck', function(data){
      sessionStorage.setItem('sessionId', data.sessionId);
    })


    socket.on("newRound", function(data){
      console.log("new round");
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      moveHistory.innerHTML = "";

      playerTurn.innerHTML = "<div>" + data.newPlayerTurn + "'s Turn </div>";

      document.getElementById("gameScreen").style.display = "block";

      if (data.lives == 0){
        document.getElementById("handSelection").style.display = "none";
        ctx.fillText("You LOST", 50, 50);
      }
      else{
        ctx.fillText("Lives: " + data.lives, 110, 25);
        cards = data.cards;
        for (var i = 0; i < cards.length; i++){
          ctx.fillText(cards[i], 10, 25 + i * 25);
        }
      }
    })

    socket.on("clearChat", function(){
      chat.innerHTML = "";
    })

    socket.on("addToChat", function(data){
      chat.innerHTML += '<div>' + data + '</div>';
    });

    socket.on("updateGame", function(data){
      playerTurn.innerHTML = "<div>" + data.newPlayerTurn + "'s Turn </div>";
      moveHistory.innerHTML +=  '<div>' + data.pastMove + '</div>';
    })

    socket.on("displayPlayButtons", function(){
      document.getElementById("handSelection").style.display = "block";
    })

    socket.on("updatePlayerList", function(playerList){
      playerListTag.innerHTML = "";
      for (i in playerList){
        playerListTag.innerHTML += '<div>' + playerList[i].name + '</div>';
      }
    })

    chatForm.onsubmit = function(e){
      e.preventDefault();
      console.log(chatInput.value);
      socket.emit('chat', chatInput.value);
      chatInput.value = "";
    }

    // socket.on("disconnect", function(){
    //   window.setTimeout('app.connect()', 5000);
    // })

  </script>





  <script>
    function removeAllOptions(sel, removeGrp) {
      var len, groups, par;
      if (removeGrp) {
        groups = sel.getElementsByTagName('optgroup');
        len = groups.length;
        for (var i=len; i; i--) {
          sel.removeChild( groups[i-1] );
        }
      }
      len = sel.options.length;
      for (var i=len; i; i--) {
        par = sel.options[i-1].parentNode;
        par.removeChild( sel.options[i-1] );
      }
    }

    function appendDataToSelect(sel, obj) {
      var f = document.createDocumentFragment();
      var labels = [], group, opts;

      function addOptions(obj) {
        var f = document.createDocumentFragment();
        var o;
        for (var i=0, len=obj.text.length; i<len; i++) {
          o = document.createElement('option');
          o.appendChild( document.createTextNode( obj.text[i] ) );
          if ( obj.value ) {
            o.value = obj.value[i];
          }
          f.appendChild(o);
        }
        return f;
      }
      
      if ( obj.text ) {
        opts = addOptions(obj);
        f.appendChild(opts);
      } else {
        for ( var prop in obj ) {
          if ( obj.hasOwnProperty(prop) ) {
            labels.push(prop);
          }
        }
        for (var i=0, len=labels.length; i<len; i++) {
          group = document.createElement('optgroup');
          group.label = labels[i];
          f.appendChild(group);
          opts = addOptions(obj[ labels[i] ] );
          group.appendChild(opts);
        }
      }
      sel.appendChild(f);
    }

    // anonymous function assigned to onchange event of controlling select list
    document.forms['handSelection'].elements['category'].onchange = function(e) {
      var relName = 'choices[]';
      var relList = this.form.elements[relName];
      var obj = Select_List_Data[ relName ][ this.value ];

      removeAllOptions(relList, true);
      appendDataToSelect(relList, obj);

      var relName2 = 'choices2[]';
      var relList2 = this.form.elements[relName2];
      var obj2 = Select_List_Data[ relName2 ][ this.value ];

      removeAllOptions(relList2, true);
      appendDataToSelect(relList2, obj2);
    };

    var Select_List_Data = {
      'choices[]': {
        royalFlush: {
          text: ["Heart", "Spade", "Diamond", "Club"]
        },
        straightFlush: {
          text: ["Heart", "Spade", "Diamond", "Club"]
        },
        quad:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        fullHouse:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        flush: {
          text: ["Heart", "Spade", "Diamond", "Club"]
        },
        straight: {
          text: ["5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        triple:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        twoPair:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        pair:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        highCard:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        }
      },
      'choices2[]': {
        royalFlush: {
          text: []
        },
        straightFlush: {
          text: ["5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        quad:{
          text: []
        },
        fullHouse:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        flush: {
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        straight: {
          text: []
        },
        triple:{
          text: []
        },
        twoPair:{
          text: ["2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K", "A"]
        },
        pair:{
          text: []
        },
        highCard:{
          text: []
        }
      }
        
    };

    // populate associated select list when page loads
    window.onload = function() {
      var form = document.forms['handSelection'];
      
      // reference to controlling select list
      var sel = form.elements['category'];
      sel.selectedIndex = 0;

      var sel2 = form.elements['category'];
      sel2.selectedIndex = 0;
      
      var relName = 'choices[]';
      var rel = form.elements[ relName ];
      var data = Select_List_Data[ relName ][ sel.value ];

      var relName2 = 'choices2[]';
      var rel2 = form.elements[ relName2 ];
      var data2= Select_List_Data[ relName2 ][ sel.value ];
      
      // add options to associated select list
      appendDataToSelect(rel, data);
      appendDataToSelect(rel2, data2);

    };
  </script>
<!-- 
  <script>
    socket.on('ping', function(data){
      socket.emit('pong', {beat: 1});
    });
  </script> -->

  
</body>



</html>
